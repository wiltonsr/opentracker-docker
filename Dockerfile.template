FROM gcc:11 as compile-stage

RUN apt update ; \
      apt install cvs -y

RUN useradd opentracker

WORKDIR /usr/src

# Run libowfat compilation in separated layer to benefit from docker layer cache
RUN cvs -d :pserver:cvs@cvs.fefe.de:/cvs -z9 co libowfat ; \
      git clone git://erdgeist.org/opentracker ; \
      cd /usr/src/libowfat ; \
      make

# http://erdgeist.org/arts/software/opentracker/#build-instructions
RUN cd /usr/src/opentracker ; \
      %%MAKEFILE_SED_EXPRESSIONS%% \
      # Build opentracker statically to use it in scratch image
      LDFLAGS=-static make ; \
      bash -c 'mkdir -pv /tmp/stage/{etc/opentracker,bin}' ; \
      cp -v opentracker.conf.sample /tmp/stage/etc/opentracker/opentracker.conf ; \
      %%OPENTRACKER_CONF_SED_EXPRESSIONS%% \
      install -m 755 opentracker.debug /tmp/stage/bin ; \
      make DESTDIR=/tmp/stage BINDIR="/bin" install

FROM scratch

COPY --from=compile-stage /tmp/stage /
COPY --from=compile-stage /etc/passwd /etc/passwd

WORKDIR /etc/opentracker

USER opentracker

EXPOSE 6969/udp
EXPOSE 6969/tcp

ENTRYPOINT ["/bin/opentracker"]
CMD ["-f", "/etc/opentracker/opentracker.conf"]
